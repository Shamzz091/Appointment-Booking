create or replace function public.create_business_for_owner(
  p_name text,
  p_slug text,
  p_type text,
  p_timezone text
)
returns uuid
language plpgsql
security definer
set search_path = public
as $$
declare
  v_bid uuid;
begin
  perform set_safe_search_path();

  -- slug unique check
  if exists (select 1 from businesses where slug = p_slug) then
    raise exception 'Slug already taken';
  end if;

  insert into businesses (name, slug, business_type, timezone, is_active)
  values (trim(p_name), lower(trim(p_slug)), trim(p_type), p_timezone, true)
  returning id into v_bid;

  insert into business_users (business_id, user_id, role)
  values (v_bid, auth.uid(), 'owner');

  return v_bid;
end $$;

grant execute on function public.create_business_for_owner(text,text,text,text) to authenticated;
