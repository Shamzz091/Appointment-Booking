-- Enable RLS on all tenant tables
ALTER TABLE businesses ENABLE ROW LEVEL SECURITY;
ALTER TABLE business_users ENABLE ROW LEVEL SECURITY;
ALTER TABLE staff ENABLE ROW LEVEL SECURITY;
ALTER TABLE staff_working_hours ENABLE ROW LEVEL SECURITY;
ALTER TABLE staff_time_off ENABLE ROW LEVEL SECURITY;
ALTER TABLE services ENABLE ROW LEVEL SECURITY;
ALTER TABLE service_staff ENABLE ROW LEVEL SECURITY;
ALTER TABLE resources ENABLE ROW LEVEL SECURITY;
ALTER TABLE clients ENABLE ROW LEVEL SECURITY;
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;
ALTER TABLE lead_activity ENABLE ROW LEVEL SECURITY;
ALTER TABLE appointments ENABLE ROW LEVEL SECURITY;
ALTER TABLE waitlist ENABLE ROW LEVEL SECURITY;
ALTER TABLE comms ENABLE ROW LEVEL SECURITY;
ALTER TABLE policies ENABLE ROW LEVEL SECURITY;
ALTER TABLE integrations ENABLE ROW LEVEL SECURITY;

-- Map (user_id, business_id) pairs
CREATE OR REPLACE VIEW v_user_business AS
SELECT bu.user_id, bu.business_id 
FROM business_users bu;

-- Businesses: users can see their own business row(s)
CREATE POLICY businesses_select ON businesses 
FOR SELECT 
TO authenticated
USING (EXISTS (
    SELECT 1 
    FROM v_user_business v 
    WHERE v.user_id = (SELECT auth.uid()) 
    AND v.business_id = id
));

-- Business_users table: full access within your business
CREATE POLICY business_users_all ON business_users 
FOR ALL 
TO authenticated
USING (
    business_id IN (
        SELECT business_id 
        FROM v_user_business 
        WHERE user_id = (SELECT auth.uid())
    )
)
WITH CHECK (
    business_id IN (
        SELECT business_id 
        FROM v_user_business 
        WHERE user_id = (SELECT auth.uid())
    )
);

-- Apply the same select+crud policy to all tables that now have a business_id
DO $$ 
DECLARE 
    t TEXT; 
BEGIN
    FOR t IN
        SELECT unnest(ARRAY[
            'staff','staff_working_hours','staff_time_off',
            'services','service_staff','resources',
            'clients','leads','lead_activity',
            'appointments','waitlist','comms',
            'policies','integrations'
        ])
    LOOP
        EXECUTE format(
            'CREATE POLICY %I ON %I FOR SELECT TO authenticated USING (
                business_id IN (
                    SELECT business_id 
                    FROM v_user_business 
                    WHERE user_id = (SELECT auth.uid())
                )
            )', t||'_select', t
        );

        EXECUTE format(
            'CREATE POLICY %I ON %I FOR ALL TO authenticated 
            USING (
                business_id IN (
                    SELECT business_id 
                    FROM v_user_business 
                    WHERE user_id = (SELECT auth.uid())
                )
            )
            WITH CHECK (
                business_id IN (
                    SELECT business_id 
                    FROM v_user_business 
                    WHERE user_id = (SELECT auth.uid())
                )
            )', t||'_crud', t
        );
    END LOOP;
END $$;
