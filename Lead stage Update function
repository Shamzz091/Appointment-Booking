create or replace function public.update_lead_stage(
    p_lead_id uuid,
    p_stage text
)
returns boolean
language plpgsql
security definer
set search_path = public
as $$
begin
  -- Validate that p_stage is one of the allowed enum values
  if not exists (
    select 1
    from unnest(enum_range(null::lead_category)) as e(val)
    where e.val = p_stage::lead_category
  ) then
    raise exception 'Invalid lead category: %', p_stage;
  end if;

  update public.leads
  set category = p_stage::lead_category
  where id = p_lead_id;

  return found; -- returns true if at least one row was updated
end;
$$;

revoke all on function public.update_lead_stage(uuid, text) from public;
grant execute on function public.update_lead_stage(uuid, text) to authenticated;
